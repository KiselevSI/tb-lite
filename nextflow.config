/*
 * nextflow.config   —   локальные SIF-контейнеры
 */

////////////////////////////////////////////////////////////////////////
// 1) ПАРАМЕТР: где лежат .sif
////////////////////////////////////////////////////////////////////////
params.sifDir = "containers"    // override:  -params-file /...json
                                         //            -with-singularity --sifDir /opt/cont

////////////////////////////////////////////////////////////////////////
// 2) БАЗОВЫЕ НАСТРОЙКИ
////////////////////////////////////////////////////////////////////////
process {
    executor  = 'local'
    cpus      = 2
    memory    = '2 GB'
}

// включаем Apptainer / Singularity и запрещаем авто-скачивание
singularity {
    enabled   = true
    autoMounts = true
    // no-pull: если контейнера нет — процесс упадёт, а мы сразу увидим проблему
    // (можно опустить, если не страшно, что Nextflow подтянет docker://)
    addOptions = '--disable-cache'
}

////////////////////////////////////////////////////////////////////////
// 3) КОНТЕЙНЕРЫ ДЛЯ КОНКРЕТНЫХ ПРОЦЕССОВ
////////////////////////////////////////////////////////////////////////
process {

  /*
   * FASTQC
   */
  withName: run_fastqc {
      container = "${params.sifDir}/fastqc_latest.sif"
      // убираем perl-локаль
      beforeScript = '''
          export LANG=C
          export LC_ALL=C
      '''
  }

  /*
   * fastp
   */
  withName: run_fastp {
      container = "${params.sifDir}/fastp_0.24.1.sif"
      cpus   = 4
  }

  /*
   * BWA MEM
   */
  withName: run_mapping {
      container = "${params.sifDir}/mapping.sif"
      cpus   = 4
      memory = '6 GB'
  }

  /*
   * bcftools mpileup / call
   */
  withName: run_call_variants {
      container = "${params.sifDir}/bcftools.1.22.sif"
      cpus   = 4
      memory = '4 GB'
  }

  /*
   * SpoTyping
   */
  withName: run_spotyping {
      container = "${params.sifDir}/spotyping.sif"
  }

   withName: run_mosdepth {
      container = "${params.sifDir}/mosd.sif"
  }

  withName: run_rd {
      container = "${params.sifDir}/rd.sif"
  }

  withName: run_tblg {
      container = "${params.sifDir}/tblg.sif"
  }

  withName: run_annotate_vcf {
        container = "${params.sifDir}/snpeff.sif"
    }
  
  withName: run_rename_chromosome {
        container = "${params.sifDir}/bcftools.1.22.sif"
    }

  withName: run_drug_resist {
        container = "${params.sifDir}/dr.sif"
    }

  withName: run_is6110 {
        container = "${params.sifDir}/ismap.sif"
    }
    
  // …добавьте остальные процессы аналогично
}

////////////////////////////////////////////////////////////////////////
// 4) ПРОФИЛИ (необязательные)
////////////////////////////////////////////////////////////////////////
profiles {

  /* Запуск на ноутбуке / сервере с Apptainer */
  singularity {
      // уже всё включено выше
  }

  /* Профиль для SLURM + Singularity */
  cluster {
      executor = 'slurm'
      queue    = 'long'
      withLabel: bigmem {
          memory = '16 GB'
          cpus   = 8
      }
  }
}
